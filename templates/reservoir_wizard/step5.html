<!doctype html>
<html lang="en">
<head><meta charset="utf-8"><title>Reservoir Wizard – Step 5</title></head>
<body>
  {% include "header2.html" %}
  <div class="wrap">
    <h1>Renew reservoir – Step 5 of 6</h1>
    <p>Run the agitator to mix the reservoir thoroughly.</p>
    <div id="secNote" style="color:#9bb4d3;">Mix time: … s</div>
    <div id="status" style="margin:12px 0;color:#9bb4d3;">Ready.</div>

    <div style="display:flex; gap:8px;">
      <button class="btn" id="mixBtn">Run agitator</button>
      <form method="post" action="{{ url_for('reservoirs.reservoir_wizard', step=5) }}">
        <button class="btn" name="action" value="back">Back</button>
        <button class="btn" name="action" value="next">Next</button>
      </form>
    </div>
  </div>

<script>
(async function(){
  const secNote = document.getElementById('secNote');
  const status  = document.getElementById('status');
  const btn     = document.getElementById('mixBtn');

  // Read seconds from global settings
  try{
    const s = await (await fetch('/api/settings', {cache:'no-store'})).json();
    const secs = Number(s?.agitator_run_sec ?? s?.agitator_mix_seconds ?? 30);
    secNote.textContent = 'Mix time: ' + (isFinite(secs) ? secs : 30) + ' s';
  }catch(e){}

  btn?.addEventListener('click', async () => {
    status.textContent = 'Mixing…';
    try{
      const r = await fetch('/api/reservoirs/mix', { method: 'POST' });
      const j = await r.json();
      if (!j.ok){
        status.textContent = 'Error: ' + (j.error || 'mix failed');
      } else {
        status.textContent = 'Mixing complete.';
      }
    }catch(e){
      status.textContent = 'Error starting agitator.';
    }
  });
})();
</script>
</body>
</html>


